---
title: "$title$"
subtitle: "$subtitle$"
abstract-title: "$abstract_title$"
abstract: "$abstract$"
date: "`r Sys.Date()`"
output: 
  dlookrExtra::dlookrExtra_$theme$_paged: 
    # Change to point to your cover file
    front_cover: $cover$
    toc: true
    # Change to true to add number in front of chapters
    number_sections: false
    # Change to true for a self-contained document, but it'll be a litte slower for Pandoc to render
    self_contained: true
# Set  toc title, default none
toc-title: Contents
#knit: pagedown::chrome_print
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages, include=FALSE, message=FALSE, warning=FALSE}
# Load required packages for charts with UNHCR style 
library(dplyr)
library(ggplot2)
library(kableExtra)
library(dlookr)
library(dlookrExtra)

reportData <- get("reportData", .dlookrExtraEnv)
```


```{css, echo=FALSE}
.pagedjs_page.pagedjs_first_page .pagedjs_margin-top-right>.pagedjs_margin-content::after {
    content: url("$logo$");
}

.title {
  color: $title_color$;
}

.subtitle {
  color: $subtitle_color$;
}
```

# Data Diagnosis

## Overview

* `r nrow(reportData) %>% format(big.mark = ",")` Observations and `r ncol(reportData)` Variables.
* `r sum(complete.cases(reportData)) %>% format(big.mark = ",")` (`r (sum(complete.cases(reportData)) / nrow(reportData) * 100) %>% round(2)`%) Complete Cases.

```{r overview, echo=FALSE, warning=FALSE, message=FALSE, results='asis'}
N <- NROW(reportData)

diagn_overview <- diagnose(reportData)

names(diagn_overview) <- c("variables", "type", "missing value(n)",
                           "missing value(%)", "unique value(n)",
                           "unique value(n/N)")

cap <- "Data quality overview table"

print_tab(diagn_overview, caption = cap, n_rows = 23, add_row = 5)
```

$content_missing$
## Missing Values
### List of Missing Values
```{r missing-data, echo=FALSE, warning=FALSE, message=FALSE, results='asis'}
diagn_missing <- diagn_overview %>%
  filter(`missing value(n)` > 0) %>%
  arrange(desc(`missing value(n)`))

if (NROW(diagn_missing) > 0) {
  cap <- "Variables that include missing values"
  
  print_tab(diagn_missing, caption = cap, n_rows = 25)
  
} else {
  cat("No variables including missing values")
  break_page_asis()
}
```

### Visualization
```{r missing-viz, dpi=300, echo=FALSE, warning=FALSE, message=FALSE, fig.height=8, fig.width=8, results='asis'}
if (NROW(diagn_missing) > 0) {
  plot_na_pareto(reportData, only_na = TRUE) +
    theme(axis.text.x = element_text(angle = 30, hjust = 1))
} else {
  cat("No variables including missing values")
}
break_page_asis()
```
$content_missing$

## Unique Values

### Categorical Vaiables 
```{r unique-date-category, echo=FALSE, warning=FALSE, message=FALSE, results='asis'}
thres <- $thres_uniq_cat$
  
diagn_uniq_cat <- diagn_overview %>%
  filter(type %in% c("character", "factor", "ordered")) %>%
  filter(`unique value(n/N)` >= thres) %>%
  arrange(desc(`unique value(n/N)`))

if (NROW(diagn_uniq_cat) > 0) {
  cap <- paste("Variables where the proportion of unique data is more than", thres)
  
  print_tab(diagn_uniq_cat, caption = cap, n_rows = 25, add_row = 4)
} else {
  cat(paste("No variable with a high proportion greater than", thres))
  break_page_asis()
}
```

### Numerical Variables
```{r unique-data-numeric, echo=FALSE, warning=FALSE, message=FALSE, results='asis'}
thres <- $thres_uniq_num$
  
diagn_uniq_num <- diagn_overview %>%
  filter(type %in% c("numeric", "integer")) %>%
  filter(`unique value(n/N)` <= thres) %>%
  arrange(desc(`unique value(n/N)`))

if (NROW(diagn_uniq_num) > 0) {
  cap <- paste("Variables where the proportion of unique data is less than", thres)
  
  print_tab(diagn_uniq_num, caption = cap, n_rows = 25, add_row = 4)
} else {
  cat(paste("No variable with unique data proportion less than", thres))
  break_page_asis()  
}
```


# Categorical Variable Diagnosis
## Top Ranks
```{r diagnose-catagory, echo=FALSE, warning=FALSE, message=FALSE, comment="", results='asis'}
diagn_category <- diagnose_category(reportData, top = 10, type = "n")

if (NROW(diagn_category) > 0) {
  names(diagn_category)[5] <- "ratio(%)"

  cap <- "Top 10 levels of categorical variables"
  
  print_tab(diagn_category, caption = cap, n_rows = 25, add_row = 4)
} else {
  cat("No categorical variable<br>")
  break_page_asis()
}
```

# Numerical Variable Diagnosis
## Distributions
```{r diagnose-numeric, echo=FALSE, warning=FALSE, message=FALSE, results='asis'}
diagn_numeric <- diagnose_numeric(reportData)

if (NROW(diagn_numeric) > 0) {
  cap <- "General list of numerical diagnosis"
  
  print_tab(diagn_numeric, caption = cap, font_size = 13, n_rows = 25, add_row = 4)
} else {
  cat("No numerical variable")
  break_page_asis()  
}
```

$content_zero$
### Zero Values
```{r numeric-zero, echo=FALSE, warning=FALSE, message=FALSE, results='asis'}
if (NROW(diagn_numeric) > 0) {
  diagn_zero <- diagn_numeric %>%
    filter(zero > 0) %>%
    select(variables, min, median, max, zero) %>%
    mutate(`zero ratio(%)` = zero / N * 100) %>%
    arrange(desc(zero))

  if (NROW(diagn_zero) > 0) {
    cap <- "List of numerical diagnosis (zero)"
  
    print_tab(diagn_zero, caption = cap, n_rows = 25, add_row = 4)
  } else {
    cat("No numeric variable with zero value")
    break_page_asis()      
  }
} else {
  cat("No numerical variable")
  break_page_asis()    
}
```
$content_zero$

$content_minus$
### Minus Values
```{r numeric-minus, echo=FALSE, warning=FALSE, message=FALSE, results='asis'}
if (NROW(diagn_numeric) > 0) {
  diagn_minus <- diagn_numeric %>%
    filter(minus > 0) %>%
    select(variables, min, median, max, minus) %>%
    mutate(`minus ratio(%)` = minus / N * 100) %>%
    arrange(desc(minus))

  if (NROW(diagn_minus) > 0) {
    cap <- "List of numerical diagnosis (minus)"
  
    print_tab(diagn_minus, caption = cap, n_rows = 25, add_row = 4)
  } else {
    cat("No numeric variable with negative value")
    break_page_asis()   
  }
} else {
  cat("No numerical variable")
  break_page_asis()     
}
```
$content_minus$

## Outliers
### List of Outliers

```{r outliers, echo=FALSE, warning=FALSE, message=FALSE, results='asis'}
if (NROW(diagn_numeric) > 0) {
  diagn_outlier <- diagn_numeric %>%
    filter(outlier > 0) %>%
    select(variables, min, median, max, outlier) %>%
    mutate(`outlier ratio(%)` = outlier / N * 100) %>%
    arrange(desc(outlier))

  if (NROW(diagn_outlier) > 0) {
    cap <- "Diagnosis of numerical variable outliers"
  
    print_tab(diagn_outlier, caption = cap, n_rows = 25, add_row = 4)
  } else {
    cat("No numeric variables including outliers")
    break_page_asis() 
  }
} else {
  cat("No numerical variable")
  break_page_asis() 
}
```

### Individual Outliers
```{r detail-outliers, echo=FALSE, warning=FALSE, message=FALSE, comment="", fig.height=4, fig.width=6, results='asis'}
if (NROW(diagn_numeric) > 0) {
  diagn_outlier2 <- reportData %>%
    diagnose_outlier(diagn_outlier$variables)

  cols <- c("Outliers count", "Outliers ratio (%)", "Mean of outliers",
            "Mean with outliers", "Mean without outliers")

  if (NROW(diagn_outlier2) > 0) {
    variables <- diagn_outlier2 %>%
      select(variables) %>%
      unlist

    for (i in seq(variables)) {
      cap <- sprintf("variable: %s", variables[i])
      cat(sprintf("<h3>%s</h3>", cap))

      outlier_df <- data.frame(Measures = cols,
                               Values = as.vector(t(diagn_outlier2[i, -1])))

      knitr::kable(outlier_df, digits = 2, caption = variables[i], format = "html",
                   table.attr = "class=\"table table-width\"") %>% 
        kable_styling(full_width = FALSE, font_size = 14, position = "center") %>% 
        cat()

      cat("<br><br>")
      
      plot_outlier(reportData, variables[i])
      
      break_page_asis()
    }
  } else {
    cat("No numeric variables including outliers")
  }
} else {
  cat("No numerical variable")
}
```

