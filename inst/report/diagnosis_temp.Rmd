---
title: "dlookr: Data Diagnosis"
author: ""
always_allow_html: yes
output:
  dlookrExtra::dlookrExtra_templ_html:
    toc: true
---

```{r setup, echo=FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      message = FALSE, 
                      warning = FALSE, 
                      collapse = FALSE,
                      comment = "#>",
                      fig.align = "center")
knitr::opts_chunk$set(fig.width = 12, fig.height = 9)
```

```{r load_packages}
library(dlookr)
library(dlookrExtra)
library(dplyr)
library(kableExtra)
library(reactable)
library(htmltools)
```

```{r udf}
# User defined functions
html_cat <- function(msg) {
  div(class = "caption", style = "padding-top: 8px; padding-bottom: 8px;
      color: #777777; text-align: left;", msg) %>% 
    as.character() %>% 
    cat()
}
```

```{r import-data}
reportData <- get("reportData", .dlookrExtraEnv)
```

```{css, echo=FALSE}
#header .title{
  color: $title_color$;
}

#header .navbar-wrapper {
  border-top: solid 1px $navbar$;
  border-bottom: solid 1px $navbar$;
}

.list-group-item.active, .list-group-item.active:hover, .list-group-item.active:focus {
    z-index: 2;
    color: #fff;
    background-color: $listgitem$;
    border-color: $listgitem$;
}

.nav-tabs>li.active>a, .nav-tabs>li.active>a:focus, .nav-tabs>li.active>a:hover {
    color: #555;
    cursor: default;
    background-color: #fff;
    border: 1px solid #ddd;
    border-bottom-color: transparent;
}

.nav-tabs>li>a {
    margin-right: 2px;
    line-height: 1.42857143;
    border: 1px solid transparent;
    border-radius: 4px 4px 0 0;
}

.nav>li>a {
    position: relative;
    display: block;
    padding: 10px 15px;
}

a {
    color: #337ab7 !important;
    text-decoration: none;
}

/* Warnings */
.tag {
  display: inline-block;
  padding: 2px 12px;
  border-radius: 15px;
  font-weight: 600;
  font-size: 12px;
}

.recommand-check {
  background: hsl(116, 60%, 90%);
  color: hsl(116, 30%, 25%);
}

.recommand-judgement {
  background: hsl(230, 70%, 90%);
  color: hsl(230, 45%, 30%);
}

.recommand-remove {
  background: hsl(350, 70%, 90%);
  color: hsl(350, 45%, 30%);
}
```

```{r diagose}
# Number of observations
N <- NROW(reportData)

# solve the overview
ov <- overview(reportData)

# diagnose the missing & unique
diagn_na_unique <- diagnose(reportData)

# diagnose the numeric
diagn_numeric <- diagnose_numeric(reportData)

tab_warning <- data.frame(
  warnings = character(500), status = character(500), variables = character(500),
  indicator = numeric(500), ratio = numeric(500), recommand = character(500))

# duplicate --------------------------------------------------------------------
idx_last <- 0
n_duplicate <- length(attr(ov, "duplicate"))

if (n_duplicate > 0) {
  idx <- 1
  
  tab_warning$status[idx]    <- "duplicate"
  tab_warning$variables[idx] <- NA
  tab_warning$indicator[idx] <- n_duplicate
  tab_warning$ratio[idx]     <- n_duplicate / N
  tab_warning$warnings[idx]  <- sprintf(
    "dataset has %s (%s%%) duplicated observations", 
    format(n_duplicate, big.mark = ","),
    round(n_duplicate / N * 100, 1))
  tab_warning$recommand[idx]  <- "check"  
}


# missing ----------------------------------------------------------------------
idx_last <- idx_last + length(idx)

warn_miss <- diagn_na_unique %>% 
  filter(missing_count > 0) %>% 
  select(variables, missing_count, missing_percent) %>% 
  arrange(desc(missing_count))

if (nrow(warn_miss) > 0) {
  idx <- seq(nrow(warn_miss)) + idx_last
  
  tab_warning$status[idx]    <- "missing"
  tab_warning$variables[idx] <- warn_miss$variables
  tab_warning$indicator[idx] <- warn_miss$missing_count
  tab_warning$ratio[idx]     <- warn_miss$missing_percent / 100
  tab_warning$warnings[idx]  <- sprintf(
    "%s has %s (%s%%) missing values", warn_miss$variables,
    format(warn_miss$missing_count, big.mark = ","),
    round(warn_miss$missing_percent, 1))
  tab_warning$recommand[idx]  <- "judgement"
}  

# cardinally: identifier -------------------------------------------------------
idx_last <- idx_last + length(idx)

warn_identifier <- diagn_na_unique %>% 
  filter(unique_rate == 1) %>% 
  select(variables, unique_count, unique_rate)

if (nrow(warn_identifier) > 0) {
  idx <- seq(nrow(warn_identifier)) + idx_last
  
  tab_warning$status[idx]     <- "cardinally"
  tab_warning$variables[idx]  <- warn_identifier$variables
  tab_warning$indicator[idx]  <- warn_identifier$unique_count
  tab_warning$ratio[idx]      <- warn_identifier$unique_rate 
  tab_warning$warnings[idx]   <- sprintf(
    "%s has high(%.2f) cardinality, Maybe identifier",
    warn_identifier$variables, warn_identifier$unique_rate)
  tab_warning$recommand[idx]  <- "check"  
}  

# cardinally: constant ---------------------------------------------------------
idx_last <- idx_last + length(idx)

warn_constant <- diagn_na_unique %>% 
  filter(unique_count == 1) %>% 
  select(variables, unique_count, unique_rate)

if (nrow(warn_constant) > 0) {
  idx <- seq(nrow(warn_constant)) + idx_last
  
  tab_warning$status[idx]     <- "cardinally"
  tab_warning$variables[idx]  <- warn_constant$variables
  tab_warning$indicator[idx]  <- warn_constant$unique_count
  tab_warning$ratio[idx]      <- warn_constant$unique_rate 
  tab_warning$warnings[idx]   <- sprintf(
    "%s has constant value \"%s\"",
    warn_constant$variables, unlist(reportData[1, warn_constant$variables]))  
  tab_warning$recommand[idx]  <- "remove"
}

# cardinally: zeros ------------------------------------------------------------
idx_last <- idx_last + length(idx)

warn_zero <- diagn_numeric %>% 
  filter(zero > 0) %>% 
  select(variables, zero) %>% 
  arrange(desc(zero))

if (nrow(warn_zero) > 0) {
  idx <- seq(nrow(warn_zero)) + idx_last
  
  tab_warning$status[idx]     <- "zeros"
  tab_warning$variables[idx]  <- warn_zero$variables
  tab_warning$indicator[idx]  <- warn_zero$zero
  tab_warning$ratio[idx]      <- warn_zero$zero / N 
  tab_warning$warnings[idx]   <- sprintf(
    "%s has %s (%s%%) zeros",
    warn_zero$variables, warn_zero$zero, round(tab_warning$ratio[idx] * 100, 2))  
  tab_warning$recommand[idx]  <- "check"
}

# cardinally: negative ---------------------------------------------------------
idx_last <- idx_last + length(idx)

warn_minus <- diagn_numeric %>% 
  filter(minus > 0) %>% 
  select(variables, minus) %>% 
  arrange(desc(minus))

if (nrow(warn_minus) > 0) {
  idx <- seq(nrow(warn_minus)) + idx_last
  
  tab_warning$status[idx]     <- "negative"
  tab_warning$variables[idx]  <- warn_minus$variables
  tab_warning$indicator[idx]  <- warn_minus$minus
  tab_warning$ratio[idx]      <- warn_minus$minus / N 
  tab_warning$warnings[idx]   <- sprintf(
    "%s has %s (%s%%) negative",
    warn_minus$variables, warn_minus$minus, round(tab_warning$ratio[idx] * 100, 2))  
  tab_warning$recommand[idx]  <- "check"
}

tab_warning <- tab_warning %>% 
  filter(status != "")
```

# Overview
## Data Structures

```{r overview_pre, results='asis'}
tab_left <- ov[1:9, ]
tab_right <- ov[10:nrow(ov), ]
rownames(tab_right) <- seq(nrow(tab_right))

cap <- "Data Structures"
knitr::kable(tab_left, digits = 2, caption = cap, format = "html",
             format.args = list(big.mark = ","),
             table.attr = "style=\"margin-right:50px !important;\"") %>% 
  kable_styling(full_width = FALSE, font_size = 15, position = "float_left") 

cap <- "Data Types"
knitr::kable(tab_right, digits = 2, caption = cap, format = "html",
             format.args = list(big.mark = ",")) %>% 
  kable_styling(full_width = FALSE, font_size = 15, position = "left") 

breaks <- 9 - nrow(tab_right) + 3
break_line_asis(breaks)
```

## Warnings
```{r warnings, results='asis'}
tab_warning %>% 
  select(warnings, status, recommand) %>% 
  reactable(
    columns = list(
      warnings = colDef(
        cell = function(value) {
          variable_name <- strsplit(value, " ") %>% unlist() %>% "["(1)
          msg <- strsplit(value, " ") %>% unlist() %>% "["(-1) %>% paste(collapse = " ")
          msg <- paste("", msg)
          
          if (variable_name == "dataset") {
            variable <- div(style = list(color = "black"), variable_name)            
          } else {
            variable <- div(style = list(color = "red"), variable_name)
          }

          tagList(
            div(style = list(display = "inline-block"), variable),
            msg
          )
        }
      ),
      status = colDef(name = "types", width = 100),
      recommand = colDef(
        width = 120,
        cell = function(value) {
          class <- paste0("tag recommand-", tolower(value))
          div(class = class, value)
        }
      )  
    )
  )

break_line_asis(2)
```

## Variables
```{r variables, results='asis'}
alert_variable(reportData)

break_line_asis(2)
```

# Missing Values
## List of Missing Values
```{r missing_data, comment="", results='asis'}
names(diagn_na_unique) <- c("variables", "type", "missing value(n)",
                           "missing value(%)", "unique value(n)",
                           "unique value(n/N)")

diagn_missing <- diagn_na_unique %>%
  filter(`missing value(n)` > 0) %>%
  arrange(desc(`missing value(n)`)) %>% 
  select(-5, -6)

if (NROW(diagn_missing) > 0) {
  cap <- "Variables that include missing values"
  
  knitr::kable(diagn_missing, digits = 2, caption = cap, format = "html",
               format.args = list(big.mark = ",")) %>% 
    kable_styling(full_width = FALSE, font_size = 15, position = "left") 

} else {
  html_cat("No variables including missing values")
  break_line_asis(1)
}

break_line_asis(1)
```

## Visualization
```{r missing-viz, dpi=300, fig.height=6, fig.width=8, results='asis'}
if (NROW(diagn_missing) > 0) {
  plot_na_pareto(reportData, only_na = TRUE) +
    theme(axis.text.x = element_text(angle = 30, hjust = 1))
} else {
  html_cat("No variables including missing values")
  break_line_asis(1)
}

break_line_asis(1)
```


# Unique Values
## Categorical Vaiables 
```{r unique_date_category, comment="", results='asis'}
thres <- $thres_uniq_cat$
  
diagn_uniq_cat <- diagn_na_unique %>%
  filter(type %in% c("character", "factor", "ordered")) %>%
  filter(`unique value(n/N)` >= thres) %>%
  arrange(desc(`unique value(n/N)`))

if (NROW(diagn_uniq_cat) > 0) {
  cap <- "Variables where the proportion of unique data is more than 0.5"
  
  knitr::kable(diagn_uniq_cat, digits = 2, caption = cap, format = "html",
               format.args = list(big.mark = ",")) %>% 
    kable_styling(full_width = FALSE, font_size = 15, position = "left") 
} else {
  html_cat("No variable with a high proportion greater than 0.5")
  break_line_asis(1)
}

break_line_asis(1)
```

## Numerical Variables
```{r unique_data_numeric, comment="", results='asis'}
thres <- $thres_uniq_num$
  
diagn_uniq_num <- diagn_na_unique %>%
  filter(type %in% c("numeric", "integer")) %>%
  filter(`unique value(n/N)` <= thres) %>%
  arrange(desc(`unique value(n/N)`))

if (NROW(diagn_uniq_num) > 0) {
  cap <- "Variables where the proportion of unique data is less than 0.1"
  
  knitr::kable(diagn_uniq_num, digits = 2, caption = cap, format = "html",
               format.args = list(big.mark = ",")) %>% 
    kable_styling(full_width = FALSE, font_size = 15, position = "left") 
} else {
  html_cat("No variable with unique data proportion less than 0.1")
  break_line_asis(1)
}

break_line_asis(1)
```

# Outliers

```{r outliers, comment="", results='asis'}
if (NROW(diagn_numeric) > 0) {
  diagn_outlier <- diagn_numeric %>%
    filter(outlier > 0) 

  if (NROW(diagn_outlier) > 0) {
    cap <- "Diagnosis of numerical variable outliers"
  
    html_cat(cap)
    tab_outlier(reportData)
    
  } else {
    html_cat("No numeric variables including outliers")
    break_line_asis(1)
  }
} else {
  html_cat("No numerical variable")
  break_line_asis(1)
}

break_line_asis(1)
```

# Samples
## Duplicated
```{r duplicated, comment="", results='asis'}
cap <- "Duplicated records"
  
idx_dup <- attr(ov, "duplicated")

if (length(idx_dup)) {
  tabs <- reportData[idx_dup, ] %>%
  reactable::reactable()

  htmlwidgets::prependContent(
    tabs, 
    div(class = "caption", style = "padding-top: 8px; padding-bottom: 8px;
        color: #777777; text-align: left;", cap)
  )
} else {
  html_cat("No duplicated records")
  break_line_asis(1)
}

break_line_asis()
```

## Heads
```{r sample-head, comment="", results='asis'}
  cap <- "First few records"
  
tabs <- reportData %>% 
  head(10) %>% 
  reactable::reactable()

htmlwidgets::prependContent(tabs, 
    div(class = "caption", style = "padding-top: 8px; padding-bottom: 8px;
        color: #777777; text-align: left;", cap))

break_line_asis()
```

## Tails
```{r sample-tail, comment=""}
  cap <- "Last few records"
  
tabs <- reportData %>% 
  tail(10) %>% 
  reactable::reactable()

htmlwidgets::prependContent(tabs, 
    div(class = "caption", style = "padding-top: 8px; padding-bottom: 8px;
        color: #777777; text-align: left;", cap))
```

