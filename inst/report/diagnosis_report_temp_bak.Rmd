---
title: "$title$"
subtitle: "$subtitle$"
abstract-title: "$abstract_title$"
abstract: "$abstract$"
date: "`r Sys.Date()`"
output: 
  dlookrExtra::dlookrExtra_templ_paged: 
    # Change to point to your cover file
    front_cover: cover.jpg
    toc: true
    # Change to true to add number in front of chapters
    number_sections: false
    # Change to true for a self-contained document, but it'll be a litte slower for Pandoc to render
    self_contained: true
# Set  toc title, default none
toc-title: Contents
#knit: pagedown::chrome_print
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages, include=FALSE, message=FALSE, warning=FALSE}
# Load required packages for charts with UNHCR style 
library(dplyr)
library(ggplot2)
library(kableExtra)
library(dlookr)
library(dlookrExtra)

reportData <- get("reportData", .dlookrExtraEnv)
```


```{css, echo=FALSE}
.pagedjs_page:last-of-type {
  background-image: url("data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iODAwIiB3aWR0aD0iMTIwMCIgcHJlc2VydmVBc3BlY3RSYXRpbz0ieE1pZFlNaWQiIHZpZXdCb3g9Ii0xMDguMTY0MSAtMTM5LjAxNTUgOTM3LjQyMjIgODM0LjA5MyI+PGRlZnM+PGxpbmVhckdyYWRpZW50IGdyYWRpZW50VHJhbnNmb3JtPSJtYXRyaXgoMS4yMjE5NCAwIDAgLjgxODM3IC0uOTA2IC0zKSIgc3ByZWFkTWV0aG9kPSJwYWQiIGdyYWRpZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIiB5Mj0iNTkzLjc4NyIgeTE9IjMuNjY2IiB4Mj0iNTkwLjg2MyIgeDE9Ii43NDEiIGlkPSJhIj48c3RvcCBzdG9wLWNvbG9yPSIjQ0JDRUQwIiBvZmZzZXQ9IjAiLz48c3RvcCBzdG9wLWNvbG9yPSIjODQ4MzhCIiBvZmZzZXQ9IjEiLz48L2xpbmVhckdyYWRpZW50PjxsaW5lYXJHcmFkaWVudCBncmFkaWVudFRyYW5zZm9ybT0ibWF0cml4KC45ODk5NSAwIDAgMS4wMTAxNSAtLjkwNiAtMykiIHNwcmVhZE1ldGhvZD0icGFkIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeTI9IjU1My40NDIiIHkxPSIxNTEuNDAxIiB4Mj0iNzAzLjA2OCIgeDE9IjMwMS4wMjYiIGlkPSJiIj48c3RvcCBzdG9wLWNvbG9yPSIjMjc2REMzIiBvZmZzZXQ9IjAiLz48c3RvcCBzdG9wLWNvbG9yPSIjMTY1Q0FBIiBvZmZzZXQ9IjEiLz48L2xpbmVhckdyYWRpZW50PjwvZGVmcz48cGF0aCBmaWxsLXJ1bGU9ImV2ZW5vZGQiIGZpbGw9InVybCgjYSkiIGQ9Ik0zNjAuNTQ3IDQ4Mi45MzdDMTYxLjQyMyA0ODIuOTM3IDAgMzc0LjgyOCAwIDI0MS40NjkgMCAxMDguMTA5IDE2MS40MjMgMCAzNjAuNTQ3IDBjMTk5LjEyNSAwIDM2MC41NDcgMTA4LjEwOSAzNjAuNTQ3IDI0MS40NjkgMCAxMzMuMzU5LTE2MS40MjIgMjQxLjQ2OC0zNjAuNTQ3IDI0MS40Njh6bTU1LjE4OC0zODguNTMxYy0xNTEuMzUyIDAtMjc0LjA0NyA3My45MDgtMjc0LjA0NyAxNjUuMDc4czEyMi42OTUgMTY1LjA3OCAyNzQuMDQ3IDE2NS4wNzhjMTUxLjM1MSAwIDI2My4wNDYtNTAuNTI5IDI2My4wNDYtMTY1LjA3OCAwLTExNC41MTMtMTExLjY5NS0xNjUuMDc4LTI2My4wNDYtMTY1LjA3OHoiLz48cGF0aCBmaWxsLXJ1bGU9ImV2ZW5vZGQiIGZpbGw9InVybCgjYikiIGQ9Ik01NDkuMDk0IDM3NHMyMS44MjIgNi41ODUgMzQuNSAxM2M0LjM5OSAyLjIyNiAxMi4wMSA2LjY2OCAxNy41IDEyLjUgNS4zNzggNS43MTIgOCAxMS41IDggMTEuNWw4NiAxNDUtMTM5IC4wNjItNjUtMTIyLjA2MnMtMTMuMzEtMjIuODY5LTIxLjUtMjkuNWMtNi44MzItNS41MzEtOS43NDUtNy41LTE2LjUtNy41aC0zMy4wMjZsLjAyNiAxNTguOTc0LTEyMyAuMDUyVjE0OS45MzhoMjQ3czExMi41IDIuMDI5IDExMi41IDEwOS4wNjItMTA3LjUgMTE1LTEwNy41IDExNXptLTUzLjUtMTM1Ljk3NmwtNzQuNDYzLS4wNDgtLjAzNyA2OS4wNSA3NC41LS4wMjRzMzQuNS0uMTA3IDM0LjUtMzUuMTI1YzAtMzUuNzIyLTM0LjUtMzMuODUzLTM0LjUtMzMuODUzeiIvPjwvc3ZnPg==");
  background-position: 10mm 30mm;
  background-size: 190mm 257mm;
  background-repeat: no-repeat;
}
```

# Diagnose Data
## Overview of Diagnosis
### List of all variables quality

```{r overview, echo=FALSE, warning=FALSE, message=FALSE, results='asis'}
N <- NROW(reportData)

diagn_overview <- diagnose(reportData)

names(diagn_overview) <- c("variables", "type", "missing value(n)",
                           "missing value(%)", "unique value(n)",
                           "unique value(n/N)")

cap <- "Data quality overview table"

print_tab(diagn_overview, caption = cap, n_rows = 20)
```


### Diagnosis of missing data
```{r missing-data, echo=FALSE, warning=FALSE, message=FALSE, results='asis'}
diagn_missing <- diagn_overview %>%
  filter(`missing value(n)` > 0) %>%
  arrange(desc(`missing value(n)`))

if (NROW(diagn_missing) > 0) {
  cap <- "Variables that include missing values"
  
  print_tab(diagn_missing, caption = cap, n_rows = 25)
  
} else {
  cat("No variables including missing values")
  break_page_asis()
}
```



### Diagnosis of unique data(Text and Category)
```{r unique-date-category, echo=FALSE, warning=FALSE, message=FALSE, results='asis'}
diagn_uniq_cat <- diagn_overview %>%
  filter(type %in% c("character", "factor", "ordered")) %>%
  filter(`unique value(n/N)` >= 0.5) %>%
  arrange(desc(`unique value(n/N)`))

if (NROW(diagn_uniq_cat) > 0) {
  cap <- "Variables where the proportion of unique data is more than 0.5"
  
  print_tab(diagn_uniq_cat, caption = cap, n_rows = 25)
} else {
  cat("No variable with a high proportion greater than 0.5")
  break_page_asis()
}
```


### Diagnosis of unique data(Numerical)
```{r unique-data-numeric, echo=FALSE, warning=FALSE, message=FALSE, results='asis'}
diagn_uniq_num <- diagn_overview %>%
  filter(type %in% c("numeric", "integer")) %>%
  filter(`unique value(n/N)` <= 0.1) %>%
  arrange(desc(`unique value(n/N)`))

if (NROW(diagn_uniq_num) > 0) {
  cap <- "Variables where the proportion of unique data is less than 0.1"
  
  print_tab(diagn_uniq_num, caption = cap, n_rows = 25)
} else {
  cat("No variable with unique data proportion less than 0.1")
  break_page_asis()  
}
```


## Detailed data diagnosis

### Diagnosis of categorical variables
```{r diagnose-catagory, echo=FALSE, warning=FALSE, message=FALSE, comment="", results='asis'}
diagn_category <- diagnose_category(reportData, top = 10, type = "n")

if (NROW(diagn_category) > 0) {
  names(diagn_category)[5] <- "ratio(%)"

  cap <- "Top 10 levels of categorical variables"
  
  print_tab(diagn_category, caption = cap)
} else {
  cat("No categorical variable<br>")
  break_page_asis()
}
```


### Diagnosis of numerical variables
```{r diagnose-numeric, echo=FALSE, warning=FALSE, message=FALSE, results='asis'}
diagn_numeric <- diagnose_numeric(reportData)

if (NROW(diagn_numeric) > 0) {
  cap <- "General list of numerical diagnosis"
  
  print_tab(diagn_numeric, caption = cap, font_size = 13)
} else {
  cat("No numerical variable")
  break_page_asis()  
}
```


### List of numerical diagnosis (zero)
```{r numeric-zero, echo=FALSE, warning=FALSE, message=FALSE, results='asis'}
if (NROW(diagn_numeric) > 0) {
  diagn_zero <- diagn_numeric %>%
    filter(zero > 0) %>%
    select(variables, min, median, max, zero) %>%
    mutate(`zero ratio(%)` = zero / N * 100) %>%
    arrange(desc(zero))

  if (NROW(diagn_zero) > 0) {
    cap <- "List of numerical diagnosis (zero)"
  
    print_tab(diagn_zero, caption = cap)
  } else {
    cat("No numeric variable with zero value")
    break_page_asis()      
  }
} else {
  cat("No numerical variable")
  break_page_asis()    
}
```


### List of numerical diagnosis (minus)
```{r numeric-minus, echo=FALSE, warning=FALSE, message=FALSE, results='asis'}
if (NROW(diagn_numeric) > 0) {
  diagn_minus <- diagn_numeric %>%
    filter(minus > 0) %>%
    select(variables, min, median, max, minus) %>%
    mutate(`minus ratio(%)` = minus / N * 100) %>%
    arrange(desc(minus))

  if (NROW(diagn_minus) > 0) {
    cap <- "List of numerical diagnosis (minus)"
  
    print_tab(diagn_minus, caption = cap)
  } else {
    cat("No numeric variable with negative value")
    break_page_asis()   
  }
} else {
  cat("No numerical variable")
  break_page_asis()     
}
```


# Diagnose Outliers
## Overview of Diagnosis
### Diagnosis of numerical variable outliers

```{r outliers, echo=FALSE, warning=FALSE, message=FALSE, results='asis'}
if (NROW(diagn_numeric) > 0) {
  diagn_outlier <- diagn_numeric %>%
    filter(outlier > 0) %>%
    select(variables, min, median, max, outlier) %>%
    mutate(`outlier ratio(%)` = outlier / N * 100) %>%
    arrange(desc(outlier))

  if (NROW(diagn_outlier) > 0) {
    cap <- "Diagnosis of numerical variable outliers"
  
    print_tab(diagn_outlier, caption = cap)
  } else {
    cat("No numeric variables including outliers")
    break_page_asis() 
  }
} else {
  cat("No numerical variable")
  break_page_asis() 
}
```


## Detailed outliers diagnosis
```{r detail-outliers, echo=FALSE, warning=FALSE, message=FALSE, comment="", fig.height=4, fig.width=6, results='asis'}
if (NROW(diagn_numeric) > 0) {
  diagn_outlier2 <- reportData %>%
    diagnose_outlier(diagn_outlier$variables)

  cols <- c("Outliers count", "Outliers ratio (%)", "Mean of outliers",
            "Mean with outliers", "Mean without outliers")

  if (NROW(diagn_outlier2) > 0) {
    variables <- diagn_outlier2 %>%
      select(variables) %>%
      unlist

    for (i in seq(variables)) {
      cap <- sprintf("variable: %s", variables[i])
      cat(sprintf("<h3>%s</h3>", cap))

      outlier_df <- data.frame(Measures = cols,
                               Values = as.vector(t(diagn_outlier2[i, -1])))

      knitr::kable(outlier_df, digits = 2, caption = variables[i], format = "html",
                   table.attr = "class=\"table table-width\"") %>% 
        kable_styling(full_width = FALSE, font_size = 14, position = "center") %>% 
        cat()

      cat("<br><br>")
      
      plot_outlier(reportData, variables[i])
      
      break_page_asis()
    }
  } else {
    cat("No numeric variables including outliers")
  }
} else {
  cat("No numerical variable")
}
```

